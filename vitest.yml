name: Vitest CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  TEST_PORTAL_URL: ${{ secrets.TEST_PORTAL_URL }}
  TEST_PORTAL_API_KEY: ${{ secrets.TEST_PORTAL_API_KEY }}
  CLI_BRANCH: fix/send-logic
  BUILD_NAME: ${{ github.workflow }}
  BUILD_NUMBER: ${{ github.run_number }}
  BUILD_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
  REPOSITORY_NAME: ${{ github.repository }}
  REPOSITORY_URL: ${{ github.server_url }}/${{ github.repository }}
  BRANCH_NAME: ${{ github.head_ref || github.ref_name }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout main repository
      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          repository: sv-kisel/vitest-junit
          ref: main

      - name: Show files
        run: ls -la

      # 2️⃣ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3️⃣ Install dependencies
      - name: Install dependencies
        run: |
          node -v
          npm -v
          npm install

      # 4️⃣ Run Vitest tests
      - name: Run Vitest
        run: npm run test

      - name: Upload Vitest report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vitest-report
          path: reports/vitest-report.json

      # 5️⃣ Checkout CLI repo
      - name: Checkout CLI repo
        if: always()
        uses: actions/checkout@v4
        with:
          repository: Vention-Test-Portal/test-portal-integration-cli
          ref: fix/send-logic
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          path: utils-repo

      - name: List utils-repo files
        if: always()
        run: ls -la utils-repo

      # 6️⃣ Install and build CLI repo
      - name: Install & build CLI
        if: always()
        run: |
          cd utils-repo
          npm install
          npm run build

      # 7️⃣ Process Vitest report with CLI
      - name: Process Vitest report
        if: always()
        run: |
          VITEST_REPORT=$GITHUB_WORKSPACE/reports/vitest-report.json
          SCRIPT_PATH=$GITHUB_WORKSPACE/utils-repo/dist/src/cli.js
          echo "TEST_PORTAL_URL: $TEST_PORTAL_URL"
          echo "TEST_PORTAL_API_KEY: $TEST_PORTAL_API_KEY"

          ls -l $VITEST_REPORT || true
          ls -l $SCRIPT_PATH || true

          node $SCRIPT_PATH -i "$VITEST_REPORT" -t vitest
































































